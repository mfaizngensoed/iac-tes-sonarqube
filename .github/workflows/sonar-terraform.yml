name: Terraform SonarCloud Security Scan

# Trigger workflow pada push ke branch utama dan pull request
on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]
  
  # Opsional: Bisa juga dijalankan manual
  workflow_dispatch:

# Permissions yang dibutuhkan (principle of least privilege)
permissions:
  contents: read
  pull-requests: write  # Untuk menulis komentar di PR jika perlu

jobs:
  sonarcloud:
    name: SonarCloud Security Analysis
    runs-on: ubuntu-latest
    
    # Environment variables yang aman
    env:
      TERRAFORM_VERSION: '1.9.0'
    
    steps:
      # ========================================
      # 1. Checkout Repository
      # ========================================
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 sangat penting untuk SonarCloud
          # Agar bisa mendeteksi "New Code" dan melakukan git blame
          fetch-depth: 0
          
      # ========================================
      # 2. Setup Terraform
      # ========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      # ========================================
      # 3. Terraform Security Checks
      # ========================================
      # Validasi format code
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      # Initialize Terraform (tanpa backend remote untuk keamanan)
      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        continue-on-error: true
      
      # Validasi syntax dan konfigurasi
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        continue-on-error: true
      
      # ========================================
      # 4. SonarCloud Security Scan
      # ========================================
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          # GITHUB_TOKEN: Token bawaan GitHub Actions (otomatis tersedia)
          # Digunakan untuk integrasi dengan GitHub (komentar PR, status checks)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # SONAR_TOKEN: Token rahasia SonarCloud
          # HARUS disimpan sebagai GitHub Secret (Settings > Secrets > Actions)
          # JANGAN PERNAH hardcode token ini di file!
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
          # SONAR_HOST_URL: URL SonarCloud
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          # Pass configuration melalui arguments (lebih aman dari secrets)
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectName=${{ secrets.SONAR_PROJECT_NAME }}
            -Dsonar.verbose=false
            
      # ========================================
      # 5. Quality Gate Check
      # ========================================
      - name: Check SonarCloud Quality Gate
        id: sonarcloud-quality-gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        # Fail pipeline jika Quality Gate tidak lulus
        continue-on-error: false
      
      # ========================================
      # 6. Fetch SonarCloud Metrics (Complexity Analysis)
      # ========================================
      - name: Get SonarCloud Complexity Metrics
        if: always()
        id: sonar-metrics
        continue-on-error: true
        run: |
          # Fetch metrics dari SonarCloud API
          METRICS="complexity,cognitive_complexity,code_smells,bugs,vulnerabilities,security_hotspots,coverage,duplicated_lines_density"
          
          RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/measures/component?component=${{ secrets.SONAR_PROJECT_KEY }}&metricKeys=${METRICS}")
          
          # Parse JSON response dan extract values
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Extract individual metrics
          COMPLEXITY=$(echo "$RESPONSE" | grep -o '"complexity".*"value":"[^"]*"' | grep -o '[0-9.]*' | head -1)
          COGNITIVE=$(echo "$RESPONSE" | grep -o '"cognitive_complexity".*"value":"[^"]*"' | grep -o '[0-9.]*' | head -1)
          BUGS=$(echo "$RESPONSE" | grep -o '"bugs".*"value":"[^"]*"' | grep -o '[0-9.]*' | head -1)
          VULNERABILITIES=$(echo "$RESPONSE" | grep -o '"vulnerabilities".*"value":"[^"]*"' | grep -o '[0-9.]*' | head -1)
          CODE_SMELLS=$(echo "$RESPONSE" | grep -o '"code_smells".*"value":"[^"]*"' | grep -o '[0-9.]*' | head -1)
          
          echo "complexity=${COMPLEXITY:-0}" >> $GITHUB_OUTPUT
          echo "cognitive_complexity=${COGNITIVE:-0}" >> $GITHUB_OUTPUT
          echo "bugs=${BUGS:-0}" >> $GITHUB_OUTPUT
          echo "vulnerabilities=${VULNERABILITIES:-0}" >> $GITHUB_OUTPUT
          echo "code_smells=${CODE_SMELLS:-0}" >> $GITHUB_OUTPUT
      
      # ========================================
      # 7. Report Status & Complexity Analysis
      # ========================================
      - name: Report Scan Results
        if: always()
        run: |
          echo "### ðŸ” Terraform Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Format | ${{ steps.fmt.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Init | ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SonarCloud Quality Gate | ${{ steps.sonarcloud-quality-gate.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Code Complexity Analysis (Cyclomatic Complexity)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formula**: V(G) = E - N + 2" >> $GITHUB_STEP_SUMMARY
          echo "- V(G) = Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
          echo "- E = Total jumlah edge (aliran kontrol)" >> $GITHUB_STEP_SUMMARY
          echo "- N = Total jumlah node (blok kode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Cyclomatic Complexity** | ${{ steps.sonar-metrics.outputs.complexity }} | Kompleksitas struktural kode |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cognitive Complexity** | ${{ steps.sonar-metrics.outputs.cognitive_complexity }} | Kompleksitas pemahaman kode |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bugs** | ${{ steps.sonar-metrics.outputs.bugs }} | Jumlah bug terdeteksi |" >> $GITHUB_STEP_SUMMARY
          echo "| **Vulnerabilities** | ${{ steps.sonar-metrics.outputs.vulnerabilities }} | Kerentanan keamanan |" >> $GITHUB_STEP_SUMMARY
          echo "| **Code Smells** | ${{ steps.sonar-metrics.outputs.code_smells }} | Masalah maintainability |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View detailed report on SonarCloud](https://sonarcloud.io/dashboard?id=${{ secrets.SONAR_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY
