name: Terraform SonarCloud Security Scan

# Trigger workflow pada push ke branch utama dan pull request
on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]
  
  # Opsional: Bisa juga dijalankan manual
  workflow_dispatch:

# Permissions yang dibutuhkan (principle of least privilege)
permissions:
  contents: read
  pull-requests: write  # Untuk menulis komentar di PR jika perlu

jobs:
  sonarcloud:
    name: SonarCloud Security Analysis
    runs-on: ubuntu-latest
    
    # Environment variables yang aman
    env:
      TERRAFORM_VERSION: '1.9.0'
    
    steps:
      # ========================================
      # 1. Checkout Repository
      # ========================================
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 sangat penting untuk SonarCloud
          # Agar bisa mendeteksi "New Code" dan melakukan git blame
          fetch-depth: 0
          
      # ========================================
      # 2. Setup Terraform
      # ========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      # ========================================
      # 3. Terraform Security Checks
      # ========================================
      # Validasi format code
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      # Initialize Terraform (tanpa backend remote untuk keamanan)
      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        continue-on-error: true
      
      # Validasi syntax dan konfigurasi
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        continue-on-error: true
      
      # ========================================
      # 4. SonarCloud Security Scan
      # ========================================
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          # GITHUB_TOKEN: Token bawaan GitHub Actions (otomatis tersedia)
          # Digunakan untuk integrasi dengan GitHub (komentar PR, status checks)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # SONAR_TOKEN: Token rahasia SonarCloud
          # HARUS disimpan sebagai GitHub Secret (Settings > Secrets > Actions)
          # JANGAN PERNAH hardcode token ini di file!
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
          # SONAR_HOST_URL: URL SonarCloud
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          # Pass configuration melalui arguments (lebih aman dari secrets)
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectName=${{ secrets.SONAR_PROJECT_NAME }}
            -Dsonar.verbose=false
            
      # ========================================
      # 5. Quality Gate Check
      # ========================================
      - name: Check SonarCloud Quality Gate
        id: sonarcloud-quality-gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        # Fail pipeline jika Quality Gate tidak lulus
        continue-on-error: false
      
      # ========================================
      # 6. Fetch SonarCloud Metrics (Complexity Analysis)
      # ========================================
      - name: Get SonarCloud Complexity Metrics
        if: always()
        id: sonar-metrics
        continue-on-error: true
        run: |
          # Wait for SonarCloud to process the analysis
          echo "â³ Waiting for SonarCloud to process metrics..."
          sleep 15
          
          # Fetch metrics dari SonarCloud API
          METRICS="complexity,cognitive_complexity,code_smells,bugs,vulnerabilities,security_hotspots,coverage,duplicated_lines_density"
          
          echo "ðŸ” Fetching metrics from SonarCloud API..."
          RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/measures/component?component=${{ secrets.SONAR_PROJECT_KEY }}&metricKeys=${METRICS}")
          
          echo "ðŸ“¥ Full API Response:"
          echo "$RESPONSE"
          echo ""
          
          # Install jq for better JSON parsing
          echo "Installing jq..."
          sudo apt-get update -qq && sudo apt-get install -qq -y jq > /dev/null 2>&1
          
          # Check if response has error
          ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].msg // empty')
          if [ ! -z "$ERROR" ]; then
            echo "âŒ API Error: $ERROR"
            echo "complexity=N/A" >> $GITHUB_OUTPUT
            echo "cognitive_complexity=N/A" >> $GITHUB_OUTPUT
            echo "bugs=0" >> $GITHUB_OUTPUT
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "code_smells=0" >> $GITHUB_OUTPUT
            echo "security_hotspots=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Parse JSON response dengan jq (lebih reliable)
          COMPLEXITY=$(echo "$RESPONSE" | jq -r '.component.measures[]? | select(.metric=="complexity") | .value // "N/A"')
          COGNITIVE=$(echo "$RESPONSE" | jq -r '.component.measures[]? | select(.metric=="cognitive_complexity") | .value // "N/A"')
          BUGS=$(echo "$RESPONSE" | jq -r '.component.measures[]? | select(.metric=="bugs") | .value // "0"')
          VULNERABILITIES=$(echo "$RESPONSE" | jq -r '.component.measures[]? | select(.metric=="vulnerabilities") | .value // "0"')
          CODE_SMELLS=$(echo "$RESPONSE" | jq -r '.component.measures[]? | select(.metric=="code_smells") | .value // "0"')
          SECURITY_HOTSPOTS=$(echo "$RESPONSE" | jq -r '.component.measures[]? | select(.metric=="security_hotspots") | .value // "0"')
          
          # If empty, set to N/A
          [ -z "$COMPLEXITY" ] && COMPLEXITY="N/A"
          [ -z "$COGNITIVE" ] && COGNITIVE="N/A"
          
          echo ""
          echo "âœ… Parsed Metrics:"
          echo "Complexity: $COMPLEXITY"
          echo "Cognitive Complexity: $COGNITIVE"
          echo "Bugs: $BUGS"
          echo "Vulnerabilities: $VULNERABILITIES"
          echo "Code Smells: $CODE_SMELLS"
          echo "Security Hotspots: $SECURITY_HOTSPOTS"
          
          # Save to outputs
          echo "complexity=${COMPLEXITY}" >> $GITHUB_OUTPUT
          echo "cognitive_complexity=${COGNITIVE}" >> $GITHUB_OUTPUT
          echo "bugs=${BUGS}" >> $GITHUB_OUTPUT
          echo "vulnerabilities=${VULNERABILITIES}" >> $GITHUB_OUTPUT
          echo "code_smells=${CODE_SMELLS}" >> $GITHUB_OUTPUT
          echo "security_hotspots=${SECURITY_HOTSPOTS}" >> $GITHUB_OUTPUT
      
      # ========================================
      # 7. Report Status & Complexity Analysis
      # ========================================
      - name: Report Scan Results
        if: always()
        run: |
          echo "### ðŸ” Terraform Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Format | ${{ steps.fmt.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Init | ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SonarCloud Quality Gate | ${{ steps.sonarcloud-quality-gate.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Code Complexity Analysis (Cyclomatic Complexity)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formula**: V(G) = E - N + 2" >> $GITHUB_STEP_SUMMARY
          echo "- V(G) = Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
          echo "- E = Total jumlah edge (aliran kontrol)" >> $GITHUB_STEP_SUMMARY
          echo "- N = Total jumlah node (blok kode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Cyclomatic Complexity** | ${{ steps.sonar-metrics.outputs.complexity }} | Kompleksitas struktural kode |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cognitive Complexity** | ${{ steps.sonar-metrics.outputs.cognitive_complexity }} | Kompleksitas pemahaman kode |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bugs** | ${{ steps.sonar-metrics.outputs.bugs }} | Jumlah bug terdeteksi |" >> $GITHUB_STEP_SUMMARY
          echo "| **Vulnerabilities** | ${{ steps.sonar-metrics.outputs.vulnerabilities }} | Kerentanan keamanan |" >> $GITHUB_STEP_SUMMARY
          echo "| **Code Smells** | ${{ steps.sonar-metrics.outputs.code_smells }} | Masalah maintainability |" >> $GITHUB_STEP_SUMMARY
          echo "| **Security Hotspots** | ${{ steps.sonar-metrics.outputs.security_hotspots }} | Potensi masalah keamanan |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: Nilai N/A berarti metric belum tersedia dari SonarCloud (biasanya untuk file konfigurasi seperti Terraform). Nilai 0 berarti tidak ada issues. Lihat logs 'Get SonarCloud Complexity Metrics' untuk detail API response." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View detailed report on SonarCloud](https://sonarcloud.io/dashboard?id=${{ secrets.SONAR_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY
